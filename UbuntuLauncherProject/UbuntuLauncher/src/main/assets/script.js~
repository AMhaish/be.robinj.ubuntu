var bootscreenDelay = 200;
var launcherEdit = false;
var scrollable = new Array ();
var runningAndroid4x = true;
var cached = new Array ();
var dragging = false;
var avgColour;
var runningJellyBean = false;
var dashOpened = false;
var appOpened = false;

var dashAppInfoPinned = false;
var dashAppInfoIndex = -1;

$(document).ready
(
	function ()
	{
		try
		{
			runningJellyBean = android.isRunningJellyBean ();

			if (runningJellyBean)
				$('body').addClass ('versionJb');
			else
				$('body').addClass ('versionIcs');
			
			// checkPrefSwapDashTrash ();
			
			var windowWidth = $(window).width ();
			
			$('div#desktop div#wallpaper').css ('background-image', 'url(' + android.getWallpaper ().getPath () + ')');
			avgColour = android.getWallpaper ().getAverageColourRgb ();
			
			// var launcherColour = android.getWallpaperAverageColourDarker ();
			var launcherColour = avgColour;
			var style = '.chameleonic { background-color: rgba(' + avgColour + ',0.6) !important; } .chameleonicLight { background-color: rgba(' + launcherColour + ',0.2) !important; } .chameleonicVeryLight { background-color: rgba(' + avgColour + ',0.1) !important; } div.unity.panel.dashOpened { background-color: rgba(' + launcherColour + ',0.2) !important; background-image: none; } div.unity.launcher.dashOpened { background-color: rgba(' + launcherColour + ',0.2) !important; }';
			$('html head').append ('<style type="text/css">' + style + '</style>');
			
			$('div#loadingScreen').hide (0);
			$('div#desktop').show (0,
				function ()
				{
					$('div.unity.panel').show (0,
						function ()
						{
							$('div.unity.launcher').show (0,
								function ()
								{
									$('.launcherIcon.launcherSpinner').hide (0,
										function ()
										{
											loadAppList ();
										}
									);
								}
							);
						}
					);
				}
			);
		}
		catch (ex)
		{
			handleException (ex);
		}
		
		/*# System #*/
		$('#exception').click
		(
			function ()
			{
				alert ("Oops, it seems like an error occured! If you don't mind helping me (the developer) out, please send an e-mail to android-dev@robinj.be. Include when this error occured, which device you have, and what the red bar at the bottom of the screen tells you. This information will help me fix the problem.");
			}
		);
		
		$('div.windowClose').click
		(
			function ()
			{
				try
				{
					$('div.window div.windowPreferences').hide (0);
					$('div.window').hide (0);
					
					setAppOpened (false);
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		/*# Dash #*/
		$('div.launcherIcon.bfb').click
		(
			function ()
			{
				try
				{
					if (! getDashOpened ())
						openDash ();
					else
						closeDash ();
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		$('div.dashRibbon img').click
		(
			function ()
			{
				try
				{
					if ($(this).hasClass ('ribbonRecent'))
						openDashRecent ();
					else if ($(this).hasClass ('ribbonApps'))
						openDashApps ();
					else if ($(this).hasClass ('ribbonFiles'))
						openDashFiles ();
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		$('div.dashClose').click
		(
			function ()
			{
				try
				{
					closeDash ();
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		$('.appList').on ('click', '.appLauncher',
			function (e)
			{
				var id = parseInt ($(this).attr ('data-index'));
				launchApp (id);
			}
		);
		
		$('.recentApps').on ('click', '.appLauncher',
			function (e)
			{
				var id = parseInt ($(this).attr ('data-index'));
				launchRecentApp (id);
			}
		);
		
		$('.dashSearch input').keyup
		(
			function (e)
			{
				try
				{
					openDashSearchResults ();
				
					var pattern = $(this).val ();
					var results = android.searchApps (pattern);
					
					var selector = '';
					for (var i = 0; i < results.size (); i++)
					{
						if (i > 0)
							selector += ', '
						selector += '.dashRecent .appList .appLauncher[data-index=' + results.get (i).toString () + ']';
					}
					
					var $apps = $(selector).clone ();
					$('.dashSearchResults .appList').html ($apps);
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		$('.dashAppInfo').on ('click', '.appInfoBack',
			function (e)
			{
				openDashApps ();
			}
		);
		
		$('.dashAppInfo').on ('click', '.appInfoPin',
			function (e)
			{
				if (dashAppInfoPinned)
					android.pinApp (dashAppInfoIndex);
				else
					android.unpinApp (dashAppInfoIndex);
				
				refreshPinnedApps ();
			}
		);
		
		$('.dashAppInfo').on ('click', '.appInfoLaunch',
			function (e)
			{
				openDashApps ();
			}
		);
		
		/*# Trash #*/
		$('div.launcherIcon.launchTrash').click
		(
			function ()
			{
				try
				{
					if (! launcherEdit)
					{
						enableLauncherEdit ();
						openDash ();
					}
					else
					{
						disableLauncherEdit ();
						closeDash ();
					}
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		/*# Preferences #*/
		$('input#prefSwapDashTrash').change
		(
			function ()
			{
				try
				{
					android.prefsPutBoolean ('swapDashTrash', $('input#prefSwapDashTrash').prop ('checked'));
					checkPrefSwapDashTrash ();
				}
				catch (ex)
				{
					handleException (ex);
				}
			}
		);
		
		/*# Panel #*/
		$('.indicator.powerCog').click
		(
			function ()
			{
				android.openMenu ();
			}
		);
	}
);

function handleException (ex)
{
	try
	{
		$('#exception').hide (0).html (ex).show (0);
	}
	catch (e)
	{
		alert ('Unhandled exception: ' + ex);
	}
}

/*# Events #*/
function event_backButtonPressed ()
{
	try
	{
		if (dashOpened)
			closeDash ();
		else if (appOpened)
			closeEverything ();
		else
			android.appQuit ();
	
	}
	catch (ex)
	{
		handleException (ex)
	}
}

function event_longPress ()
{
	try
	{
		var index = $('.appLauncher:hover').attr ('data-index');
		alert ($('.appLauncher:hover').html ());
		alert ($('.appLauncher:active').html ());
		alert ($('div:hover').html ());
		if (typeof index !== 'undefined')
			openDashAppInfo (index);
	}
	catch (ex)
	{
		handleException (ex)
	}
}

/*# Other stuff #*/

function closeEverything ()
{
	$('div.windowClose').trigger ('click');
	closeDash ();
}

function openDash (shouldOpenDashRecent)
{
	if (typeof shouldOpenDashRecent === 'undefined')
		shouldOpenDashRecent = true;
	
	$('*').addClass ('dashOpened');
	setDashOpened (true);
	
	if (shouldOpenDashRecent)
		openDashRecent ();
}

function openDashRecent ()
{
	$('div.dashContent div.dashPage').hide (0);
	
	$('div.dashRibbon img').removeClass ('activeRibbonItem');
	$('div.dashRibbon img.ribbonRecent').addClass ('activeRibbonItem');
	
	$('div.dashPage').removeClass ('activeDash');
	$('div.dashPage.dashRecent').addClass ('activeDash');
	
	var html = android.getInstalledApps ().toHtml ('');
	
	$('div.dashPage.dashRecent div.appList').html (html);
	$('div.dashContent div.dashPage.dashRecent').show (0);
}

function openDashApps ()
{
	$('div.dashContent div.dashPage').hide (0);
	
	$('div.dashRibbon img').removeClass ('activeRibbonItem');
	$('div.dashRibbon img.ribbonApps').addClass ('activeRibbonItem');
	
	$('div.dashPage').removeClass ('activeDash');
	$('div.dashPage.dashApps').addClass ('activeDash');
	
	var html = android.getInstalledApps ().toHtml ('');
	
	$('div.dashPage.dashApps div.appList').html (html);
	$('div.dashContent div.dashPage.dashApps').show (0);
}

function openDashFiles ()
{
	$('div.dashContent div.dashPage').hide (0);
	
	$('div.dashRibbon img').removeClass ('activeRibbonItem');
	$('div.dashRibbon img.ribbonFiles').addClass ('activeRibbonItem');
	
	$('div.dashPage').removeClass ('activeDash');
	$('div.dashPage.dashFiles').addClass ('activeDash');
	
	$('div.dashPage.dashFiles div.fileList').html (getHomeDirectoryListString ());
	$('div.dashContent div.dashPage.dashFiles').show (0);
}

function openDashSearchResults ()
{
	if (! $('div.dashPage.dashSearchResults').hasClass ('activeDash'))
	{
		$('div.dashContent div.dashPage').hide (0);
	
		$('div.dashRibbon img').removeClass ('activeRibbonItem');
	
		$('div.dashPage').removeClass ('activeDash');
		$('div.dashPage.dashSearchResults').addClass ('activeDash');
	
		$('div.dashContent div.dashPage.dashSearchResults').show (0);
	}
}

function openDashAppInfo (index, pinned)
{
	if (typeof pinned === 'undefined')
		pinned = false;
	
	$('div.dashContent div.dashPage').hide (0);
	
	$('div.dashRibbon img').removeClass ('activeRibbonItem');
	$('div.dashRibbon img.ribbonApps').addClass ('activeRibbonItem');
	
	$('div.dashPage').removeClass ('activeDash');
	$('div.dashPage.dashAppInfo').addClass ('activeDash');
	
	dashAppInfoPinned = pinned;
	dashAppInfoIndex = index;
	
	var info = (pinned ? android.getPinnedApps () : android.getInstalledApps ()).get (parseInt (index)).infoToHtml (); // Without parseInt (), index would always be 0 on the Java side //
	
	$('div.dashPage.dashAppInfo .appInfo').html (info);
	$('div.dashContent div.dashPage.dashAppInfo').show (0);
}

function closeDash ()
{
	$('div.dashApps').hide (0,
		function ()
		{
			$('*').removeClass ('dashOpened');
			disableLauncherEdit ();
			$('div.dashContent div.dashPage').hide (0);
			setDashOpened (false);
		}
	);
}

function launchApp (i)
{
	try
	{
		android.launchApp (i);
		updateRecentApps ();
	}
	catch (ex)
	{
		handleException (ex);
	}
}

function launchRecentApp (i)
{
	try
	{
		android.launchRecentApp (i);
		updateRecentApps ();
	}
	catch (ex)
	{
		handleException (ex);
	}
}

function addRecentAppToLauncher (id, showInLauncher)
{
	if (typeof showInLauncher === 'undefined')
		showInLauncher = true;
	
	var launcherId = android.addRecentToLauncher (id);
	var label = android.getRecentApplicationLabel (id);
	var icon = android.getRecentApplicationIconFile (id);
	var colour = android.getRecentApplicationIconAverageColour (id);
	$('div.unity.launcher div.launcherApps').append ('<div class="launcherIcon appLauncher" style="background-color: rgba(' + colour + ',0.8);" id="appLauncher' + launcherId + '" onClick="launchFromLauncher (' + launcherId + ');"><img src="' + icon + '" alt="' + label + '" /></div>');
	
	if (showInLauncher)
		$('#appLauncher' + launcherId).show (0);
}

function enableLauncherEdit ()
{
	var previousState = launcherEdit;
	launcherEdit = true;
	$('*').addClass ('launcherEditEnabled');
	if (! previousState)
		android.showToast ('Launcher Edit mode enabled');
}

function disableLauncherEdit ()
{
	var previousState = launcherEdit;
	launcherEdit = false;
	$('*').removeClass ('launcherEditEnabled');
	if (previousState)
		android.showToast ('Launcher Edit mode disabled');
}

function launchFromLauncher (i)
{
	try
	{
		if (! launcherEdit)
		{
			android.launchFromLauncher (i);
		}
		else
		{
			removeFromLauncher (i);
			
			if (! runningJellyBean)
			{
				$('div.launcherIcon.launchTrash').trigger ('click');
			}
		}
	}
	catch (ex)
	{
		handleException (ex);
	}
}

function removeFromLauncher (i)
{
	android.removeFromLauncher (i);
	/*$('#appLauncher' + i).hide (0,
		function ()
		{
			$('#appLauncher' + i).remove ();
		}
	);*/
	$('#appLauncher' + i).remove ();
}

function openFile (file)
{
	try
	{
		android.openFile (file);
	}
	catch (ex)
	{
		handleException (ex);
	}
}

function openPreferences ()
{
	try
	{
		closeEverything ();
		
		$('input#prefSwapDashTrash').prop ('checked', android.prefsGetBoolean ('swapDashTrash'));
		
		$('div.window').show (0);
		$('div.window div.windowPreferences').show (0);
		
		setAppOpened (true);
	}
	catch (ex)
	{
		handleException (ex);
	}
}

function checkPrefSwapDashTrash ()
{
	if (android.prefsGetBoolean ('swapDashTrash'))
		$('.launcherIcon.bfb, .launcherIcon.launchTrash').addClass ('prefSwapDashTrash');
	else
		$('.launcherIcon.bfb, .launcherIcon.launchTrash').removeClass ('prefSwapDashTrash');
}

function setAppOpened (val)
{
	appOpened = val;
}

function setDashOpened (val)
{
	dashOpened = val;
}

function getAppOpened ()
{
	return appOpened;
}

function getDashOpened ()
{
	return dashOpened;
}

function loadAppList ()
{
	/*if (android.isAsyncLoadApplistDone ())
	{
		$('.launcherIcon.bfb').show (0);
		
		restoreLaunchers ();
	}
	else
	{
		setTimeout (loadAppList, 1000);
	}*/

	$('.launcherIcon.bfb').show (0);
	restoreLaunchers ();
}

function restoreLaunchers ()
{
	/*if (android.isAsyncLoadLaunchersDone ())
	{
		$('.launcherIcon.launcherSpinner').hide (0);
		
		var count = android.countLaunchers ();
		for (var i = 0; i < count; i++)
		{
			var resInf = android.getLauncher (i);
			addAppToLauncher (resInf, false);
		}
		
		$('.launcherIcon.launchTrash').show (0,
			function ()
			{
				/-*$('.launcherApps .launcherIcon').not ('.launcherIcon.launcherSpinner').each
				(
					function (i)
					{
						$(this).delay (i * 200).slideDown (400);
					}
				);*-/
				$('.launcherApps .launcherIcon').not ('.launcherIcon.launcherSpinner').show (0);
			}
		);
	}
	else
	{
		setTimeout (restoreLaunchers, 1000);
	}*/
	
	$('.launcherApps').html (android.getPinnedApps ().toHtml ('dashIcon'));
	$('.launcherIcon.launchTrash').show (0);
}

function updateRecentApps ()
{
	//$('div.recentApps').hide (0).html (android.getRecentAppsHtml ()).show (0);
}

function getCached (code)
{
	var result = '';
	
	if (typeof cached[code] !== 'undefined')
		result = cached[code];
	else
		result = eval (code);
	
	cached[code] = result;
	
	return result;
}

function refreshPinnedApps ()
{
	$('div.unity.launcher div.launcherApps').html (android.getPinnedApps ().toHtml ('launcherIcon'));
}

function debugLayoutOnPc ()
{
	$('div#loadingScreen').show (0);
	$('div#desktop').show (0,
		function ()
		{
			$('div.unity.panel').how (
				function ()
				{
					$('div.unity.launcher').show (0,
						function ()
						{
							$('div.launcherIcon').show (0);
						}
					);
				}
			);
		}
	);
}
